# Delta Twin Component: Fire Weather Index forecast

This document describes a Delta Twin component that calculates and plots Fire Weather Index (FWI) forecast data as a processing service.

## Overview

**Data inputs**
- [MSG fire risk map](https://data.destination-earth.eu/data-portfolio/EO.EUM.DAT.MSG.LSA-FRM)

**Services**
- HDA
- Delta Twin

**Outputs**
- Regular fire weather index plots over some AOI
- Published delta twin component
- Tutorial document

## Building a Delta Twin component using HDA

### Data

Find the collection ID via the UI. The key identifiers are:

```
HDA_STAC_ENDPOINT="https://hda.data.destination-earth.eu/stac/v2"
COLLECTION_ID = "EO.EUM.DAT.MSG.LSA-FRM"
```

Variables

### AOI

The AOI used here is the Cobières Massif, a region in France that [recently suffered from wild fire](https://en.wikipedia.org/wiki/2025_Corbi%C3%A8res_Massif_wildfire).

```
bbox = [2.10, 42.65, 3.25, 43.35]
```

## Creating a Delta Twin component locally

### inputs.json

All we need as inputs are DESP auth credentials:

```
{
  "user": {
    "type": "string",
    "value": "johnsmith"
  },
  "password": {
    "type": "string",
    "value": "XXXXXX"
  }
}
```

### manifest.json

Follow the guide [here](https://deltatwin.destine.eu/docs/tutorials/basic/tutorial_basic_step3).

- Fill in ownership details and name at the top
- No resources - these are more for connecting inputs (not explained well in docs)

#### Inputs and outputs

The component exposes two inputs and one output in [manifest.json](manifest.json):

- `inputs.user` is a `string` because local CLI runs accept plaintext values.
- `inputs.password` is a `secret` because credentials should not be stored in plain text when running on the service.
- `outputs.fwi-plot` is a `Data` output and is wired to any PNG generated by the model.

The model definition `models.fwi-calculator` declares the same inputs and a `fwi-plot` output with `glob: "*.png"`. That glob matches the PNG file produced by the script. The model command is:

`python fwi.py $(inputs.user) $(inputs.password)`

which maps the workflow inputs directly to the CLI arguments consumed by [models/fwi_calculator/fwi.py](models/fwi_calculator/fwi.py).

#### CLI secret limitation

There is a known issue: the CLI cannot decrypt `secret` values from `inputs.json`. If you set `type: "secret"` in the inputs file, the run fails with a `fromhex()` error. For local runs, keep both inputs as `string` in the JSON file (see [inputs-djp.json](inputs-djp.json)). For service runs, publish the component and pass the secret via the UI, which handles encryption for `secret` inputs.

### Run locally

```
deltatwin run start_local -i inputs-djp.json
```

### Publish and run

```
deltatwin component publish -t fwi 0.1
```

Then:

```
deltatwin run start fwi-calc -i inputs.json
```

If the output is missing, check the workflow wiring in [workflow.yml](workflow.yml). The output node must reference `outputs.fwi-plot` and the edge must connect the `fwi` node output port `fwi-plot` to the `plot` node.

### workflow.yml

The workflow defines the graph that connects inputs to the model and then to the output:

- `user` and `password` nodes reference `inputs.user` and `inputs.password`.
- The `fwi` node references `models.fwi-calculator`.
- The `plot` node references `outputs.fwi-plot`.

Edges connect the inputs to the model’s input ports and connect the model’s output port to the output node. The important wiring is:

`from: id: fwi, port: fwi-plot` → `to: id: plot`

This matches the output name declared in the model definition and makes the generated PNG available as the component output.

### How the script maps to inputs/outputs

[models/fwi_calculator/fwi.py](models/fwi_calculator/fwi.py) expects two CLI arguments: `user` and `password`. These are used to set `DESPAUTH_USER` and `DESPAUTH_PASSWORD` before calling `destinepyauth.get_token()`.

The script writes PNG output files to a run-specific folder under `.data/` and logs their filenames. The `glob: "*.png"` in the model output captures these files and exposes them as the `fwi-plot` output defined in [manifest.json](manifest.json).