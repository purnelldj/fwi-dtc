# Delta Twin Component: Fire Weather Index forecast

This Delta Twin component plots Fire Weather Index (FWI) forecast data as a processing service.

The most recent fire risk forecast data is taken from the [MSG fire risk map](https://data.destination-earth.eu/data-portfolio/EO.EUM.DAT.MSG.LSA-FRM) and then plotted as a png. The Delta Twin component relies on the HDA (Harmonized Data Access) service.

## Workflow

The workflow is defined in [workflow.yml](workflow.yml) and wires workflow inputs to the model and then to the component output declared in [manifest.json](manifest.json).

The workflow defines the graph that connects inputs to the model and then to the output:

- `user` and `password` nodes reference `inputs.user` and `inputs.password`.
- The `fwi` node references `models.fwi-calculator`.
- The `plot` node references `outputs.fwi-plot`.

Edges connect the inputs to the model’s input ports and connect the model’s output port to the output node. The important wiring is:

```yaml
  - from:
      id: fwi
      port: fwi-plot
    to:
      id: plot
```

This matches the output name declared in the model definition and makes the generated PNG available as the component output.

| **Node** | **Kind** | **Description** |
| -------- | -------- | --------------- |
| user | input | DESP auth username passed to the model as the first CLI argument (`user`). |
| password | input | DESP auth password passed to the model as the second CLI argument (`password`). |
| fwi | model | The Python model that searches the HDA STAC catalog, downloads an MSG fire risk product, and generates PNG plot(s). |
| plot | output | The output node wired to `outputs.fwi-plot`, which captures the PNG(s) produced by the model. |

## Steps to build the component

### Local testing of the model

The model is implemented in [models/fwi_calculator/fwi.py](models/fwi_calculator/fwi.py) and expects two CLI arguments.

[models/fwi_calculator/fwi.py](models/fwi_calculator/fwi.py) expects two CLI arguments: `user` and `password`. These are used to set `DESPAUTH_USER` and `DESPAUTH_PASSWORD` before calling `destinepyauth.get_token()`.

The key identifiers for data access are:
```
HDA_STAC_ENDPOINT="https://hda.data.destination-earth.eu/stac/v2"
COLLECTION_ID = "EO.EUM.DAT.MSG.LSA-FRM"
```

To install the Python dependencies locally:

```shell
pip install -r models/fwi_calculator/requirements.txt
```

To run the model locally:

```shell
python models/fwi_calculator/fwi.py <username> <password>
```

The `glob: "fwi.png"` in the model output captures the output plot from the model and exposes it as the `fwi-plot` output defined in [manifest.json](manifest.json).

### Creating a Delta Twin component locally

### inputs.json

All we need as inputs are DESP auth credentials:

```json
{
  "user": {
    "type": "string",
    "value": "johnsmith"
  },
  "password": {
    "type": "string",
    "value": "XXXXXX"
  }
}
```

### manifest.json

Follow the guide [here](https://deltatwin.destine.eu/docs/tutorials/basic/tutorial_basic_step3).

- Fill in ownership details and name at the top
- No resources - these are more for connecting inputs (not explained well in docs)

#### Inputs and outputs

The component exposes two inputs and one output in [manifest.json](manifest.json):

- `inputs.user` is a `string` because local CLI runs accept plaintext values.
- `inputs.password` is a `secret` because credentials should not be stored in plain text when running on the service.
- `outputs.fwi-plot` is a `Data` output and is wired to any PNG generated by the model.

The model definition `models.fwi-calculator` declares the same inputs and a `fwi-plot` output with `glob: "*.png"`. That glob matches the PNG file produced by the script. The model command is:

`python fwi.py $(inputs.user) $(inputs.password)`

which maps the workflow inputs directly to the CLI arguments consumed by [models/fwi_calculator/fwi.py](models/fwi_calculator/fwi.py).

#### CLI secret limitation

There is a known issue: the CLI cannot decrypt `secret` values from `inputs.json`. If you set `type: "secret"` in the inputs file, the run fails with a `fromhex()` error. For local runs, keep both inputs as `string` in the JSON file (see [inputs-djp.json](inputs-djp.json)). For service runs, publish the component and pass the secret via the UI, which handles encryption for `secret` inputs.

### Run locally

```shell
deltatwin run start_local -i inputs-djp.json
```

When running a component locally, input parameter(s) can be provided via a JSON file.

### Publish and run

```shell
deltatwin component publish -t fwi 0.1
```

Then:

```shell
deltatwin run start fwi-calc -i inputs.json
```

If the output is missing, check the workflow wiring in [workflow.yml](workflow.yml). The output node must reference `outputs.fwi-plot` and the edge must connect the `fwi` node output port `fwi-plot` to the `plot` node.

### How the script maps to inputs/outputs

The component exposes two inputs and one output in [manifest.json](manifest.json):

- `inputs.user` is a `string` because local CLI runs accept plaintext values.
- `inputs.password` is a `secret` because credentials should not be stored in plain text when running on the service.
- `outputs.fwi-plot` is a `Data` output and is wired to any PNG generated by the model.